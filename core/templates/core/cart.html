{% extends 'core/base.html' %}


{% block content %}

{% load static %}
{%load crispy_forms_tags %} 
















<div class="flex ">
    <div class="h-ful shadow-md bg-red-800 " id="sidenavSecExample">
        <div class="pt-1 pb-1 px-6">
            <a href="#!">
                <div class="flex items-center">
                    
                    
                </div>
            </a>
        </div>
        <ul class="relative px-1">
            <li class="relative">
                <a class="flex items-center text-sm py-4 px-6 h-12 overflow-hidden text-white text-ellipsis whitespace-nowrap rounded hover:text-blue-60 hover:bg-sky-950 hover:font-bold transition duration-300 ease-in-out"
                    href="admin/core/customer/" data-mdb-ripple="true" data-mdb-ripple-color="primary">
                    
                    <span>Admin</span>
                </a>
            </li>
      
            <li class="relative">
                <a class="flex items-center text-sm py-4 px-6 h-12 overflow-hidden  text-white text-ellipsis whitespace-nowrap rounded hover:text-white-300 hover:bg-sky-950  hover:font-bold transition duration-200 ease-in-out"
                    href="/mrinvoicelist" data-mdb-ripple="true" data-mdb-ripple-color="primary">
                    
                    <span>MR Invoice Report</span>
                </a>
            </li>



            <li class="relative">
                <a class="flex items-center text-sm py-4 px-6 h-12 overflow-hidden  text-white text-ellipsis whitespace-nowrap rounded hover:text-white-300 hover:bg-sky-950  hover:font-bold transition duration-200 ease-in-out"
                    href="/soldlist" data-mdb-ripple="true" data-mdb-ripple-color="primary">
                    
                    <span>Invoice Report</span>
                </a>
            </li>

            <li class="relative">
                <a class="flex items-center text-sm py-4 px-6 h-12 overflow-hidden  text-white text-ellipsis whitespace-nowrap rounded hover:text-white-300 hover:bg-sky-950  hover:font-bold transition duration-200 ease-in-out"
                    href="/returnlist" data-mdb-ripple="true" data-mdb-ripple-color="primary">
                    
                    <span>returnlist</span>
                </a>
            </li>


            <li class="relative">
                <a class="flex items-center text-sm py-4 px-6 h-12 overflow-hidden  text-white text-ellipsis whitespace-nowrap rounded hover:text-white-300 hover:bg-sky-950  hover:font-bold transition duration-200 ease-in-out"
                    href="bill_list" data-mdb-ripple="true" data-mdb-ripple-color="primary">
                    
                    <span>Bill receivelist</span>
                </a>
            </li>
        
            <hr class="my-2">

            <li class="relative">
                <a class="flex items-center text-sm py-4 px-6 h-12 overflow-hidden text-white text-ellipsis whitespace-nowrap rounded hover:text-white-300 hover:bg-sky-950  hover:font-bold transition duration-200 ease-in-out"
                    href="admin/core/customer/add" data-mdb-ripple="true" data-mdb-ripple-color="primary">
                    
                    <span>Add Customer</span>
                </a>

            </li>



            <li class="relative">
                <a class="flex items-center text-sm py-4 px-6 h-12 overflow-hidden text-white text-ellipsis whitespace-nowrap rounded hover:text-white-300 hover:bg-sky-950  hover:font-bold transition duration-200 ease-in-out"
                    href="admin/core/paybillcatogory/add" data-mdb-ripple="true" data-mdb-ripple-color="primary">
                    
                    <span>new expense category</span>
                </a>

            </li>

            <li class="relative">
                <a class="flex items-center text-sm py-4 px-6 h-12 overflow-hidden text-white hover:text-white whitespace-nowrap rounded hover:text-white-600 hover:bg-sky-950  hover:font-bold transition duration-300 ease-in-out"
                    href="/customerlist" data-mdb-ripple="true" data-mdb-ripple-color="primary">
                    
                    <span>Customer Ledger</span>
                </a>

            </li>
           

           

            

            
        </ul>
        <hr class="my-2">
        <ul class="relative px-1">
            <li class="relative">
                <a class="flex items-center text-sm py-4 px-6 h-12 overflow-hidden text-red-50 text-ellipsis whitespace-nowrap rounded hover:text-white-600 hover:bg-sky-950  hover:font-bold transition duration-300 ease-in-out"
                    href="/mr" data-mdb-ripple="true" data-mdb-ripple-color="primary">
                    
                    <span class="icon">
                        <ion-icon name="documents-outline"></ion-icon>
                    </span>
                    <span>MR ENTRY</span>
                </a>
            </li>
            <li class="relative">
                <a class="flex items-center text-sm py-4 px-6 h-12 overflow-hidden text-white hover:text-white text-ellipsis whitespace-nowrap rounded hover:text-white-600 hover:bg-sky-950  hover:font-bold transition duration-300 ease-in-out"
                    href="/expense" data-mdb-ripple="true" data-mdb-ripple-color="primary">
                    
                    <span class="icon">
                        <ion-icon name="documents-outline"></ion-icon>
                    </span>
                    <span>EXPENSE</span>
                </a>
            </li>
            <li class="relative">
                <a class="flex items-center text-sm py-4 px-6 h-12 overflow-hidden text-white hover:text-white text-ellipsis whitespace-nowrap rounded hover:text-white-600 hover:bg-sky-950  hover:font-bold transition duration-300 ease-in-out"
                    href="/daily" data-mdb-ripple="true" data-mdb-ripple-color="primary">
                    
                    <span class="icon">
                        <ion-icon name="documents-outline"></ion-icon>
                    </span>
                    <span>DAILY REPORT</span>
                </a>
            </li>

            <li class="relative">
                <a class="flex items-center text-sm py-4 px-6 h-12 overflow-hidden text-white hover:text-white text-ellipsis whitespace-nowrap rounded hover:text-white-600 hover:bg-sky-950  hover:font-bold transition duration-300 ease-in-out"
                    href="/salesreport" data-mdb-ripple="true" data-mdb-ripple-color="primary">
                    
                    <span class="icon">
                        <ion-icon name="documents-outline"></ion-icon>
                    </span>
                    <span>SALES REPORT</span>
                </a>
            </li>



            <li class="relative">
                <a class="flex items-center text-sm py-4 px-6 h-12 overflow-hidden text-white hover:text-white text-ellipsis whitespace-nowrap rounded hover:text-white-600 hover:bg-sky-950  hover:font-bold transition duration-300 ease-in-out"
                    href="/expensereport" data-mdb-ripple="true" data-mdb-ripple-color="primary">
                    
                    <span class="icon">
                        <ion-icon name="documents-outline"></ion-icon>
                    </span>
                    <span>Expense report </span>
                </a>
            </li>
     
            

            
            
        </ul>

    </div>


    






    <div class="basis-7/8">
        <!-- put component code here -->
       



       

        

     
        <div class="grid   grid-cols-3 gap-2  ">
            <div class="col-span-2 m-1">

                TOTAL AMMOUNT  {{totalbalace}} TK
                <div class="container mt-2">
                    <form method="GET" action=" " class="d-flex custom-form">


                        <select name="category" id="category" class="form-select">
                            <option  value=""> SELECT CATEGORY</option>
                          {% for supplier in category %}
                          <option value="{{ supplier.productcatagory  }}">{{ supplier.productcatagory }}</option>
                        {% endfor %}
                        </select>
                        <input class="form-control me-2" name="search" id="country" type="search" placeholder="Search"
                      aria-label="Search">
                        
                        
        
                       
                        
                        <button class="btn text-yellow-400 hover:text-white border border-yellow-400 hover:bg-yellow-500 focus:ring-4 focus:outline-none focus:ring-yellow-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center mr-2 mb-2 dark:border-yellow-300 dark:text-yellow-300 dark:hover:text-white dark:hover:bg-yellow-400 dark:focus:ring-yellow-900" type="submit">Search</button>
                    </form>
                </div>
                
               

                {{ form.media }}


                

                <div class="flex flex-wrap " >

                    {% for product in pro %}
    
    <a href="#"
        class="w-[47%] p-4 max-w-sm  rounded-lg border border-gray-200 shadow-md hover:bg-gray-100 dark:bg-gray-800 dark:border-gray-700 dark:hover:bg-gray-700 m-1">
        <h5 class="mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-white">
            {{ product.name}}
        </h5>
        <div class="flex justify-between">
            <p class="font-normal text-gray-700 dark:text-gray-400 px-1">
                TK{{ product.price }}
            </p>
            
            <p class="font-normal   text-red mx-1">
                Qty: {{ product.quantity }}
            </p>

            <p class="font-normal   text-red mx-1">
                cat : {{ product.productcatagory }}
            </p>
            <button
    class="save text-white bg-gradient-to-br from-pink-500 to-orange-400 hover:bg-gradient-to-bl focus:ring-4 focus:outline-none focus:ring-pink-200 dark:focus:ring-pink-800 font-small rounded-lg text-xs px-3 py-1.5 text-center mr-2 mb-2"
    onclick="window.location.href = '{{product.id}}/addproduct'">
    Add
</button>


           
        

         <button class="save btn btn-info mx-2" onclick="openModal('{{ product.id }}', '{{ product.name }}', '{{ product.price }}')">Add</button>
            

        

            {% if  product.mother == True%}
            <button class="bg-blue-500 hover:bg-blue-700 text-white text-xs font-bold py-1 px-1 rounded w-40  mr-px"
            onclick="window.location.href = '/{{product.id}}/group'">
            group
            </button>
            {% else %}
            
            
            {% endif %}


            
            
        </div>
    </a>
    
    {% endfor %}
                   
                       
                    
                </div>




<!-- Modal -->


                <div class="pagination">
                    <span class="step-links">
                        {% if pro.has_previous %}
                            <a href="?page=1">&laquo; first</a>
                            <a href="?page={{ pro.previous_page_number }}">previous</a>
                        {% endif %}
                
                        <span class="current">
                            Page {{ pro.number }} of {{ pro.paginator.num_pages }}.
                        </span>
                
                        {% if pro.has_next %}
                            <a href="?page={{ pro.next_page_number }}">next</a>
                            <a href="?page={{ pro.paginator.num_pages }}">last &raquo;</a>
                        {% endif %}
                    </span>
                </div>




                <div id="myModal" class="modal fixed inset-0 z-50 flex items-center justify-center hidden">
                    <div class="modal-overlay absolute inset-0 bg-gray-500 opacity-75"></div>
                    <div class="modal-container bg-white w-1/2 mx-auto rounded-lg shadow-lg z-50 overflow-y-auto">
                        <div class="modal-content py-4 px-6">
                            <div class="modal-header flex justify-between items-center">
                                <h4 class="modal-title text-lg font-semibold" id="myModalLabel"></h4>
                                <button class="btn btn-secondary text-white bg-red-500" onclick="closeModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <form id="modalForm">
                                    <div class="form-group">
                                        <label for="product">Product Type</label>
                                        <select id="product" name="product" class="form-control" required>
                                            <option value="Local Container">Local Container</option>
                                            <option value="Public Container">Public Container</option>
                                            <!-- Add more options as needed -->
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="quantity">Quantity:</label>
                                        <input type="number" class="form-control" id="quantity" name="quantity" value="0" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="price1">Price1:</label>
                                        <input type="number" class="form-control" id="price" name="price1" value="0" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="price2">Price2:</label>
                                        <input type="number" class="form-control" id="price2" name="price2" value="0" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="status">Status:</label>
                                        <select id="status" name="status" class="form-control" required>
                                            <option value="Direct">Direct</option>
                                            <option value="Exchange">Exchange</option>
                                            <!-- Add more options as needed -->
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="engine">Engine Complete:</label>
                                        <select id="engine" name="engine" class="form-control" required>
                                            <option value="Incomplete">Incomplete</option>
                                            <option value="Complete">Complete</option>
                                            <!-- Add more options as needed -->
                                        </select>
                                    </div>
                                    
                                   
                                   
                                    <div class="form-group">
                                        <label for="exchangeAmount">Exchange Amount:</label>
                                        <input type="number" class="form-control" id="exchangeAmount" name="exchangeAmount"  placeholder="Enter exchange amount" requ>
                                    </div>
                                    
                                    
                                    
                                    <div class="form-group">
                                        <label for="spareName">Spare Name:</label>
                                        <input type="text" class="form-control" id="spareName" name="spareName" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="remarks">Remarks:</label>
                                        <input type="text" class="form-control" id="remarks" name="remarks" required>
                                    </div>
                                    
                                    <!-- Add other necessary fields here -->
                                    <input type="hidden" id="productId" name="productId">
                                </form>
                            </div>
                            
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary bg-blue-500" onclick="addToCart()">Add to Cart</button>
                                <button type="button" class="btn btn-secondary bg-gray-500" onclick="closeModal()">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
                



            </div>

            <div>





                

                
                
                <div  class="flex flex-col justify-between block  rounded-lg shadow-lg bg-white max-w-sm p-3">
                    

                   


                    <div id="product-container">
                        <!-- Products will be inserted here by JavaScript -->
                    </div>

                    <div class="mt-2 border-t-2">
                        <div class="mt-2 flex justify-between">
                            <p class="font-bold">TOTAL</p>
                            <p class="font-bold" id="totalAmount"></p>
                        </div>
                    </div>
                    {% load crispy_forms_tags %}
                    <form method="POST" class="post-form">
                        {% csrf_token %}
                        {{ form|crispy}}
                        <br>
                        <button type="submit" class="save btn btn-info" name="btnform2">Submit</button>
                    </form>

                </div>
                
            </div>
        </div>
    </div>
</div>




<div class="container">

    <div id="task-container">
        <div id="form-wrapper">
            
        </div>

        <div id="list-wrapper">
        
        </div>	
    </div>

</div>




<script type="text/javascript">
    /*
        KEY COMPONENTS:
        "activeItem" = null until an edit button is clicked. Will contain object of item we are editing
        "list_snapshot" = Will contain previous state of list. Used for removing extra rows on list update
        
        PROCESS:
        1 - Fetch Data and build rows "buildList()"
        2 - Create Item on form submit
        3 - Edit Item click - Prefill form and change submit URL
        4 - Delete Item - Send item id to delete URL
        5 - Cross out completed task - Event handle updated item

        NOTES:
        -- Add event handlers to "edit", "delete", "title"
        -- Render with strike through items completed
        -- Remove extra data on re-render
        -- CSRF Token
    */



    $(document).ready(function() {
        $("#country").autocomplete({
            source: "{% url 'autocomplete' %}",
            minLength: 2,
            select: function(event, ui) {
                $("#country").val(ui.item.label);
               
                return false;
            }
        });
    });

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');

    var activeItem = null
    var list_snapshot = []


    loadProducts()

    function buildList(){
        var wrapper = document.getElementById('list-wrapper')
        //wrapper.innerHTML = ''



        var url = 'http://127.0.0.1:8000/api_productlist/'

        fetch(url)
        .then((resp) => resp.json())
        .then(function(data){
            console.log('Data:', data)

            var list = data
            for (var i in list){


                try{
                    document.getElementById(`data-row-${i}`).remove()
                }catch(err){

                }
        


                var title = `<span class="title">${list[i].productype}</span>`
                
              
                

                var item = `
                    <div id="data-row-${i}" class="task-wrapper flex-wrapper">
                        <div style="flex:7">
                            ${title}
                        </div>
                        <div style="flex:1">
                            <button class="btn btn-sm btn-outline-info edit">Edit </button>
                        </div>
                        <div style="flex:1">
                            <button class="btn btn-sm btn-outline-dark delete">-</button>
                        </div>
                    </div>

                `
                wrapper.innerHTML += item

            }

            if (list_snapshot.length > list.length){
                for (var i = list.length; i < list_snapshot.length; i++){
                    document.getElementById(`data-row-${i}`).remove()
                }
            }

            list_snapshot = list


            for (var i in list){
                var editBtn = document.getElementsByClassName('edit')[i]
                var deleteBtn = document.getElementsByClassName('delete')[i]
                var title = document.getElementsByClassName('title')[i]

                // editBtn.addEventListener('click', (function(item){
                // 	return function(){
                // 		editItem(item)
                // 	}
                // })(list[i]))

                //Immediatly Invoked Function (IIF) + Closure for saving current loop item in memory
                editBtn.addEventListener('click', (() => {

                    let item = list[i]
                    return () => {
                        editItem(item)
                    }
                })())


                deleteBtn.addEventListener('click', (function(item){
                    return function(){
                        deleteItem(item)
                    }
                })(list[i]))



                
                title.addEventListener('click', (function(item){
                    return function(){
                        strikeUnstrike(item)
                    }
                })(list[i]))


            }


        })
    }


    var form = document.getElementById('form-wrapper')
    form.addEventListener('submit', function(e){
        e.preventDefault()
        console.log('Form submitted')
        var url = 'http://127.0.0.1:8000/api/task-create/'
        if (activeItem != null){
            var url = `http://127.0.0.1:8000/api/task-update/${activeItem.id}/`
            activeItem = null
        }



        var title = document.getElementById('title').value
        fetch(url, {
            method:'POST',
            headers:{
                'Content-type':'application/json',
                'X-CSRFToken':csrftoken,
            },
            body:JSON.stringify({'title':title})
        }
        ).then(function(response){
            buildList()
            document.getElementById('form').reset()
        })
    })




    function editItem(item){
        console.log('Item clicked:', item)
        activeItem = item
        document.getElementById('title').value = activeItem.title
    }


    


    function loadProducts() {
    fetch('/api_productlist/')
        .then(response => response.json())
        .then(data => {
            let productContainer = document.getElementById('product-container');
            productContainer.innerHTML = ''; // Clear existing products
            console.log(data);
            const total = data.total_sum;
            document.getElementById('totalAmount').textContent = `$${total}`;

            // Loop through the tasks and create product elements
            for (let i = 0; i < data.tasks.length; i++) {
                let item = data.tasks[i];
                let productDiv = document.createElement('div');
                productContainer.appendChild(productDiv);
                productDiv.innerHTML = `
                <div id="data-row-${i}" class="task-wrapper flex-wrapper">
                    ${item.quantity} x ${item.price1} <a href='${item.product.id}/update'> <b>${item.product.name}</b> </a>
                    <span>${item.quantity * item.price1} TK</span>
                    ${item.product.mother ? '<button class="bg-blue-500 hover:bg-blue-700 text-white text-xs font-bold py-1 px-1 rounded w-10 mr-px" onclick="groupProduct(' + item.product.id + ')">Group</button>' : ''}
                    <button class="ml-2 bg-red-500 hover:bg-red-700 text-white font-bold px-1 rounded delete" data-index="${i}">X</button>
                </div>
                `;
            }

            // Delete excess rows
            if (list_snapshot.length > data.tasks.length) {
                for (let i = data.tasks.length; i < list_snapshot.length; i++) {
                    let rowToRemove = document.getElementById(`data-row-${i}`);
                    if (rowToRemove) {
                        rowToRemove.remove();
                    }
                }
            }

            list_snapshot = data.tasks;

            // Attach event listeners to delete buttons
            let deleteButtons = document.getElementsByClassName('delete');
            for (let i = 0; i < deleteButtons.length; i++) {
                deleteButtons[i].addEventListener('click', function () {
                    let index = this.getAttribute('data-index');
                    deleteItem(data.tasks[index]);
                });
            }
        });
}





function deleteItem(item) {
        console.log('Delete clicked');
        console.log(item)
        fetch(`/api-delete/${item.id}`, {
            method: 'DELETE',
            headers: {
                'Content-type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log(data); // Log the response from the server
            loadProducts(); // Reload the products list after successful deletion
        })
        .catch(error => {
            console.error('Error:', error); // Log any errors that occurred
        });
    }


    function addItemcart(item) {
        console.log('Delete clicked');
        console.log(item)
        fetch(`/apiaddproduct/${item.id}`, {
            method: 'DELETE',
            headers: {
                'Content-type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log(data); // Log the response from the server
            loadProducts(); // Reload the products list after successful deletion
        })
        .catch(error => {
            console.error('Error:', error); // Log any errors that occurred
        });
    }   


 
    function deleteproduct(id) {
    console.log('Delete clicked');
    console.log(id);
    fetch(`/api-delete/${id}`, {
        method: 'DELETE',
        headers: {
            'Content-type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log(data); // Log the response from the server
        loadProducts(); // Reload the products list after successful deletion
    })
    .catch(error => {
        console.error('Error:', error); // Log any errors that occurred
    });
}   



   


    const openModal = (productId, productName, price) => {
    const modal = document.getElementById("myModal");
    const modalTitle = modal.querySelector("#myModalLabel");
    const productIdField = modal.querySelector("#productId");
    const quantityField = modal.querySelector("#quantity");
    const priceField = modal.querySelector("#price");

    modalTitle.textContent = productName;
    productIdField.value = productId;
    quantityField.value = "";
    priceField.value = "";

    modal.classList.remove("hidden");
    document.body.classList.add("modal-open");
};

const closeModal = () => {
    const modal = document.getElementById("myModal");
    modal.classList.add("hidden");
    document.body.classList.remove("modal-open");
};

const addToCart = () => {
    const modal = document.getElementById("myModal");
    

    const productId = modal.querySelector("#productId").value;
    var product = document.getElementById("product").value;
    var quantity = document.getElementById("quantity").value;
    var price1 = document.getElementById("price").value;
    var price2 = document.getElementById("price2").value;
    var status = document.getElementById("status").value;
    var engine = document.getElementById("engine").value;
    var exchangeAmount = document.getElementById("exchangeAmount").value;
    var spareName = document.getElementById("spareName").value;
    var remarks = document.getElementById("remarks").value;

    console.log(productId)


    const formData = {
  productId: productId,
  product: product,
  quantity: quantity,
  price1: price1,
  price2: price2,
  status: status,
  engine: engine,
  exchangeAmount: exchangeAmount,
  spareName: spareName,
  remarks: remarks
};

// Make a POST request to the Django API endpoint
fetch('/api_useritemstore/', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(formData)
})
  .then(response => response.json())
  .then(data => {
    console.log("API response:", data);
    loadProducts();
    // Handle the API response here
  })
  .catch(error => {
    console.error("Error:", error);
    // Handle the error here
  });



   

    closeModal();
    

    // Perform any additional validation or processing here

    // Submit the form or make an AJAX request to add the product to the cart
    //const form = modal.querySelector("#modalForm");
    //form.submit(); // Submit the form
    // Alternatively, make an AJAX request to add the product to the cart
};  


</script>


{% endblock %}